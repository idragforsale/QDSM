window.searchTable;window.performSearch;window.clearSearch;window.readDocument;window.viewDocument;window.showLoading;window.hideLoading;$(document).ready(function(){function s(){var e=$("#mainSearch").val().trim(),t=$("#searchQIC").val().trim(),a=$("#searchDept").val().trim(),r=$("#searchStartDate").val(),n=$("#searchEndDate").val(),i=$(".quick-filter.active").data("type");if(!e&&!t&&!a&&!r&&!n&&"all"===i)return void Swal.fire({icon:"info",title:"กรุณาใส่คำค้นหา",text:"กรอกคำค้นหาหรือเลือกตัวกรองอย่างน้อย 1 รายการ",customClass:{popup:"animate__animated animate__bounceIn"}});if(r&&n&&r>n)return void Swal.fire({icon:"warning",title:"ช่วงวันที่ไม่ถูกต้อง",text:"วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด",customClass:{popup:"animate__animated animate__bounceIn"}});$("#resultsCard").show().removeClass("animate__fadeIn").addClass("animate__animated animate__fadeIn"),window.searchTable.ajax.reload(function(e){e&&e.recordsFiltered!==undefined&&($("#resultCount").text(e.recordsFiltered),0===e.recordsFiltered&&Swal.fire({icon:"info",title:"ไม่พบข้อมูล",text:"ไม่พบเอกสารที่ตรงกับเงื่อนไขการค้นหา",customClass:{popup:"animate__animated animate__bounceIn"}}))})}function c(){$("#mainSearch,#searchQIC,#searchDept,#searchStartDate,#searchEndDate").val(""),$(".quick-filter").removeClass("active"),$('.quick-filter[data-type="all"]').addClass("active"),$("#resultsCard").show(),window.searchTable.ajax.reload(),Swal.fire({icon:"success",title:"รีเซ็ตเรียบร้อย",text:"ล้างข้อมูลการค้นหาแล้ว",timer:1500,showConfirmButton:!1,customClass:{popup:"animate__animated animate__bounceIn"}})}window.performSearch=s;window.clearSearch=c;window.readDocument=function(e){if(!e)return void Swal.fire({icon:"warning",title:"ไม่พบเอกสาร",text:"เอกสารนี้ยังไม่ได้อัปโหลด",confirmButtonColor:"#ff7b59"});window.open("document.php?id="+encodeURIComponent(e),"_blank")};window.viewDocument=function(e,t){if(!e)return void Swal.fire({icon:"warning",title:"ไม่พบไฟล์",text:"ไม่มีไฟล์เอกสารสำหรับรายการนี้",customClass:{popup:"animate__animated animate__bounceIn"}});var a="uploads/"+e,n=e.split(".").pop().toLowerCase();$("#documentModalLabel").html('<i class="bi bi-file-earmark-pdf"></i> '+(t||"เอกสาร")),["pdf"].includes(n)?($("#documentViewer").attr("src",a),$("#downloadBtn").attr("href",a),$("#documentModal").modal("show")):["doc","docx","xls","xlsx"].includes(n)?($("#documentViewer").attr("src","https://view.officeapps.live.com/op/embed.aspx?src="+encodeURIComponent(window.location.origin+"/"+a)),$("#downloadBtn").attr("href",a),$("#documentModal").modal("show"),setTimeout(function(){$("#documentViewer").contents().find("body").html()==""&&Swal.fire({title:"ไม่สามารถแสดงตัวอย่างได้",text:"คลิกปุ่มดาวน์โหลดเพื่อเปิดไฟล์",icon:"info",customClass:{popup:"animate__animated animate__bounceIn"}})},3e3)):Swal.fire({title:"ดาวน์โหลดไฟล์",text:"ไฟล์ "+n.toUpperCase()+" จะถูกดาวน์โหลดโดยอัตโนมัติ",icon:"info",showCancelButton:!0,confirmButtonText:"ดาวน์โหลด",cancelButtonText:"ยกเลิก",customClass:{popup:"animate__animated animate__bounceIn"}}).then(function(e){if(e.isConfirmed){var t=document.createElement("a");t.href=a,t.download=e,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}})},window.showLoading=function(){$("#loadingOverlay").css("display","flex")},window.hideLoading=function(){$("#loadingOverlay").hide()};var e=function(){window.searchTable=$("#searchTable").DataTable({processing:!0,serverSide:!0,ajax:{url:"ajax/search_data.php",type:"POST",data:function(e){e.main_search=$("#mainSearch").val(),e.qic_search=$("#searchQIC").val(),e.dept_search=$("#searchDept").val(),e.start_date=$("#searchStartDate").val(),e.end_date=$("#searchEndDate").val(),e.type_filter=$(".quick-filter.active").data("type")},beforeSend:window.showLoading,complete:function(e){window.hideLoading(),e.responseJSON&&e.responseJSON.recordsFiltered!==undefined&&$("#resultCount").text(e.responseJSON.recordsFiltered)},error:function(e,t,a){window.hideLoading(),console.error("Search Error:",t),Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด!",text:"ไม่สามารถค้นหาข้อมูลได้",customClass:{popup:"animate__animated animate__bounceIn"}})}},columns:[{data:0,width:"8%"},{data:1,width:"8%"},{data:2,width:"10%"},{data:3,width:"25%"},{data:4,width:"12%"},{data:5,width:"10%"},{data:6,width:"10%"},{data:7,width:"8%"},{data:8,orderable:!1,searchable:!1,width:"8%"}],language:{processing:'<div class="text-center"><i class="bi bi-arrow-repeat text-orange" style="font-size: 2rem;"></i><br>กำลังค้นหา...</div>',emptyTable:'<div class="text-center text-muted"><i class="bi bi-search" style="font-size: 3rem;"></i><br>ไม่พบข้อมูลที่ค้นหา</div>',info:"แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",infoEmpty:"ไม่พบข้อมูล",infoFiltered:"(กรองจากทั้งหมด _MAX_ รายการ)",lengthMenu:"แสดง _MENU_ รายการ",search:"ค้นหา:",paginate:{first:"แรก",last:"สุดท้าย",next:"ถัดไป",previous:"ก่อนหน้า"}},order:[[0,"desc"]],pageLength:10,lengthMenu:[[10,25,50,100],[10,25,50,100]]})};e();var t=new Date;t.setDate(t.getDate()-30),$("#searchStartDate").val(t.toISOString().split("T")[0]),$("#searchEndDate").val(new Date().toISOString().split("T")[0]),$(".quick-filter").on("click",function(){$(".quick-filter").removeClass("active"),$(this).addClass("active"),window.performSearch()}),$("#mainSearch,#searchQIC,#searchDept").on("keypress",function(e){13===e.which&&window.performSearch()}),$("#searchStartDate,#searchEndDate").on("change",function(){window.performSearch()}),$(document).keydown(function(e){e.ctrlKey&&70===e.keyCode?(e.preventDefault(),$("#mainSearch").focus()):27===e.keyCode&&window.clearSearch()}),$("#mainSearch").on("input",function(){clearTimeout(window.searchTimeout);var e=$(this).val().trim();e.length>=2&&(window.searchTimeout=setTimeout(window.performSearch,1e3))}),setTimeout(function(){if(!$("#resultsCard").is(":visible"))Swal.fire({icon:"info",title:"เคล็ดลับการค้นหา",html:'<div class="text-start"><p><i class="bi bi-lightbulb text-warning"></i> <strong>เคล็ดลับ:</strong></p><ul><li>ใช้ <kbd>Ctrl+F</kbd> เพื่อโฟกัสช่องค้นหา</li><li>ใช้ <kbd>Esc</kbd> เพื่อรีเซ็ตการค้นหา</li><li>ระบบจะค้นหาอัตโนมัติเมื่อพิมพ์ครบ 2 ตัวอักษร</li><li>สามารถค้นหาได้หลายเงื่อนไขพร้อมกัน</li></ul></div>',showConfirmButton:!1,timer:5e3,customClass:{popup:"animate__animated animate__bounceIn"}}},3e3)});
